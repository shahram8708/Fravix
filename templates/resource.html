{% extends 'base.html' %}

{% block content %}
<div class="container mt-5">
    <h2 class="text-center">{{ resource.title }}</h2>
    <p class="lead text-center">{{ resource.description }}</p>

    <div class="text-center mt-4">
        {% if resource.file_url %}
        {% if 'http' in resource.file_url %}
        <a href="{{ resource.file_url }}" target="_blank" class="btn btn-info">Click here to access the material</a>
        {% else %}
        <a href="{{ url_for('download_file', filename=resource.file_url.split('/')[-1]) }}"
            class="btn btn-success">Click here to download the material</a>
        {% endif %}
        {% else %}
        <p class="text-danger">No material available for this resource.</p>
        {% endif %}
    </div>

    <h4 class="mt-4">Uploaded by: <a href="{{ url_for('user_profile', user_id=uploader.id) }}"
            class="text-decoration-none">{{ uploader.username }}</a></h4>

    <form method="GET" action="{{ url_for('favourite', resource_id=resource.id) }}" class="mt-3">
        <button type="submit" class="btn {{ 'btn-danger' if fav else 'btn-secondary' }}">
            {{ 'Remove from Favourites' if fav else 'Add to Favourites' }}
        </button>
    </form>

    <div class="mt-3">
        <button class="btn btn-info" onclick="copyShareLink()">Share this Resource</button>
        <input type="text" id="shareLink"
            value="{{ url_for('resource_detail', resource_id=resource.id, _external=True) }}"
            style="position: absolute; left: -9999px;">
        <span id="copyMessage" style="display: none; color: green; margin-left: 10px;">Link copied!</span>
    </div>

    {% if current_user.id == uploader.id %}
    <a href="{{ url_for('edit_resource', resource_id=resource.id) }}" class="btn btn-warning mt-3">Edit Resource</a>
    <form method="POST" action="{{ url_for('delete_resource', resource_id=resource.id) }}" class="mt-3">
        <button type="submit" class="btn btn-danger">Delete Resource</button>
    </form>
    {% endif %}

    <h4 class="mt-4">Ratings</h4>
    <ul class="list-group">
        {% if ratings %}
        {% for rating in ratings %}
        {% set rater = rater_usernames[rating.user_id] %}
        <li class="list-group-item">
            {% if rater %}
            <a href="{{ url_for('user_profile', user_id=rater.id) }}" class="text-decoration-none">
                {{ rater.username }}
            </a> Rated: {{ rating.score }} Stars
            {% else %}
            Unknown User Rated: {{ rating.score }} Stars
            {% endif %}
        </li>
        {% endfor %}
        {% else %}
        <li class="list-group-item">No ratings available for this resource.</li>
        {% endif %}
    </ul>

    <h5 class="mt-4">Total Score: {{ total_score }} ({{ rating_count }} ratings)</h5>

    {% if not user_rating %}
    <form method="POST" class="mt-3">
        <label for="rating" class="form-label">Rate this resource:</label>
        <select class="form-select" name="rating" id="rating" required>
            <option value="1">1 Star</option>
            <option value="2">2 Stars</option>
            <option value="3">3 Stars</option>
            <option value="4">4 Stars</option>
            <option value="5">5 Stars</option>
        </select>
        <button type="submit" class="btn btn-primary mt-2">Submit Rating</button>
    </form>
    {% else %}
    <p class="mt-2">You have already rated this resource: {{ user_rating.score }} Stars</p>
    {% endif %}
    <div class="mt-4">
        <h4 class="mb-3">Comments</h4>
        <ul class="list-group">
            {% if comments %}
            {% for comment in comments %}
            <li class="list-group-item border rounded shadow-sm mb-4">
                <div class="d-flex justify-content-between align-items-start">
                    <div>
                        <a href="{{ url_for('user_profile', user_id=comment.user_id) }}" class="text-primary fw-bold">{{
                            comment.user.username }}</a>
                        <span class="text-muted small"> Commented on {{ comment.timestamp.strftime('%d-%m-%Y %H:%M')
                            }}</span>
                    </div>
                    {% if current_user.id == comment.user_id %}
                    <form method="POST" action="{{ url_for('delete_comment', comment_id=comment.id) }}" class="ms-2">
                        <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                    </form>
                    {% endif %}
                </div>
                <p class="mt-2">{{ comment.content }}</p>

                <button class="btn btn-outline-secondary btn-sm" data-bs-toggle="collapse"
                    data-bs-target="#replyForm{{ comment.id }}" aria-expanded="false"
                    aria-controls="replyForm{{ comment.id }}">
                    Reply
                </button>

                <div class="collapse mt-3" id="replyForm{{ comment.id }}">
                    <form method="POST" class="mt-2">
                        <input type="hidden" name="comment_id" value="{{ comment.id }}">
                        <div class="input-group">
                            <input type="text" name="reply" class="form-control" placeholder="Write a reply..."
                                required>
                            <button type="submit" class="btn btn-primary">Submit</button>
                        </div>
                    </form>
                </div>

                <ul class="list-group mt-3">
                    {% if comment.replies %}
                    {% for reply in comment.replies %}
                    <li class="list-group-item border rounded shadow-sm mb-2">
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <a href="{{ url_for('user_profile', user_id=reply.user_id) }}"
                                    class="text-primary fw-bold">{{ reply.user.username }}</a>
                                <span class="text-muted small"> Replied on {% if reply.timestamp %} {{
                                    reply.timestamp.strftime('%d-%m-%Y %H:%M') }} {% else %} Unknown time {% endif
                                    %}</span>
                            </div>
                            {% if current_user.id == reply.user_id %}
                            <form method="POST" action="{{ url_for('delete_reply', reply_id=reply.id) }}">
                                <button type="submit" class="btn btn-danger btn-sm">Delete</button>
                            </form>
                            {% endif %}
                        </div>
                        <p class="mt-2">{{ reply.content }}</p>
                    </li>
                    {% endfor %}
                    {% else %}
                    <li class="list-group-item text-muted">No replies yet.</li>
                    {% endif %}
                </ul>
            </li>
            {% endfor %}
            {% else %}
            <li class="list-group-item text-muted">No comments yet for this resource.</li>
            {% endif %}
        </ul>

        <form method="POST" class="mt-4">
            <label for="comment" class="form-label fw-bold">Add a Comment:</label>
            <div class="input-group">
                <input type="text" name="comment" id="comment" class="form-control" placeholder="Write a comment"
                    required>
                <button type="submit" class="btn btn-primary">Submit</button>
            </div>
        </form>
    </div>

</div>

<script>
    function copyShareLink() {
        var copyText = document.getElementById("shareLink");
        copyText.select();
        document.execCommand("copy");
        document.getElementById("copyMessage").style.display = "inline";
        setTimeout(function () {
            document.getElementById("copyMessage").style.display = "none";
        }, 2000);
    }
</script>
{% endblock %}